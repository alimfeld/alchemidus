<html>
  <head>
    <title>Alchemidus</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="icons/apple-touch-icon.png" rel="apple-touch-icon">
    <link href="icons/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152">
    <link href="icons/apple-touch-icon-167x167.png" rel="apple-touch-icon" sizes="167x167">
    <link href="icons/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180">
    <link href="icons/icon-hires.png" rel="icon" sizes="192x192">
    <link href="icons/icon-normal.png" rel="icon" sizes="128x128">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous">
    </script>
    <script src="bundle.js"></script>
    <script>
var overlay;

function renderDice(dice) {
  var content;
  var span = $("<span class='dice'></div>");
  content = "&#" + (9855 + dice.face1) + ";";
  if (dice.areTwo()) {
    content += "&#" + (9855 + dice.face2) + ";";
  }
  span.append(content);
  return span;
}

function newGame() {
  clearTransitions();
  game = new Game();
  var cnt = 1;
  game.operations.forEach(op => {
    var div = $("<div class='layout'></div>");
    var header = $("<div class='header'></div>");
    var main = $("<div class='main'></div>");
    var footer = $("<div class='footer'></div>");
    header.append("<div class='cost'>" + op.cost + "</div>");
    var type;
    switch(op.type) {
      case 'R': type = 'Remove'; break;
      case 'G': type = 'Get'; break;
      case 'C': type = 'Change'; break;
    }
    header.append("<div class='type'>" + type + "</div>");
    header.append("<div class='id'>" + op.id + "</div>");
    var description = op.description;
    description = description.replace(/(&#x268.;)/g, "<span class='die'>$1</span>");
    main.append("<div>" + description + "</div>");
    div.append(header);
    div.append(main);
    div.append(footer);
    div.click((e) => {
      if (!overlay && !game.solved) {
        e.stopPropagation();
        applyOperation(op);
      }
    });
    $("#c" + cnt++).html(div);
  });
  $("#clay").html(renderDice(game.start));
  $("#iron").html(renderDice(game.targets[0]));
  $("#gold").html(renderDice(game.targets[1]));
}

function clearTransitions() {
  for (var i = 1; i <= 15; i++) {
    $("#c" + i + " .footer").empty();
  }
}

function applyOperation(op) {
  var transitions = op.transitions(game.sequence);
  if (transitions.length === 0) {
    return;
  }
  if (transitions.length === 1) {
    game.addTransition(transitions[0]);
    showLastTransition();
    return;
  }
  overlay = $("<div id='transitions'></div>");
  transitions.forEach(tr => {
    var entry = $("<div class='entry'></div>");
    entry.html(renderDice(tr.end));
    entry.click(() => {
      game.addTransition(tr);
      overlay.remove();
      overlay = undefined;
      showLastTransition();
    });
    overlay.append(entry);
  });
  $("#game").append(overlay);
}

function showLastTransition() {
  var transition = game.sequence.lastTransition();
  var card = game.operations.indexOf(transition.operation) + 1;
  var footer = $("#c" + card + " .footer");
  footer.append("<div class='step'>" + game.sequence.length + "</div>");
  footer.append("<div class='cost'>" + game.cost + "</div>");
  var state = $("<div class='state'></div>");
  state.addClass("remaining" + game.remainingTargets.length);
  state.append(renderDice(transition.end));
  footer.append(state);
}

function showSolution() {
  clearTransitions();
  game.reset();
  game.solution.transitions.forEach(tr => {
    game.addTransition(tr);
    showLastTransition();
  });
}

function resetGame() {
  clearTransitions();
  game.reset();
}

$(document).ready(function() {
  if (!(game instanceof Game)) {
    newGame();
  }
  $("#game").click(() => {
    if (overlay) {
      overlay.remove();
      overlay = undefined;
    }
  });
  $("#new").click(function() {
    newGame();
  });
  $("#solve").click(function() {
    showSolution();
  });
  $("#reset").click(function() {
    resetGame();
  });
});
    </script>
  </head>

  <body>
    <div id="game">
      <div id="cards">
        <div id="remove" class="category">
          <div id="c1" class="card"></div>
          <div id="c2" class="card"></div>
          <div id="c3" class="card"></div>
          <div id="c4" class="card"></div>
          <div id="c5" class="card"></div>
        </div>
        <div id="get" class="category">
          <div id="c6" class="card"></div>
          <div id="c7" class="card"></div>
          <div id="c8" class="card"></div>
          <div id="c9" class="card"></div>
          <div id="c10" class="card"></div>
        </div>
        <div id="change" class="category">
          <div id="c11" class="card"></div>
          <div id="c12" class="card"></div>
          <div id="c13" class="card"></div>
          <div id="c14" class="card"></div>
          <div id="c15" class="card"></div>
        </div>
      </div>
      <div id="goal">
        <div id="clay"></div>
        <div id="iron"></div>
        <div id="gold"></div>
      </div>
      <div id="actions">
        <div id="new" class="button">New</div>
        <div id="solve" class="button">Solve</div>
        <div id="reset" class="button">Reset</div>
      </div>
    </div>
  </body>
</html>
